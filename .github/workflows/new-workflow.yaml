name: Chamber Detection Test Workflow

on:
  push:
    branches:
      - main

jobs:
  pre_chamber_deployment:
    runs-on: ubuntu-latest
    outputs:
      aws_changed: ${{ steps.setflags.outputs.aws_changed }}
      cc_changed: ${{ steps.setflags.outputs.cc_changed }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install GitHub CLI + jq
      run: |
        sudo apt-get update
        sudo apt-get install -y gh jq

    - name: Try to reuse changed-files.txt from previous successful run (same commit SHA)
      id: download
      continue-on-error: true
      run: |
        echo "ğŸ” Looking for previous successful run with commit SHA: ${{ github.sha }}"
        
        run_id=$(gh api -H "Accept: application/vnd.github+json" \
          /repos/${{ github.repository }}/actions/runs \
          | jq -r --arg sha "${{ github.sha }}" \
            '.workflow_runs[] 
             | select(.head_sha == $sha and .name == "Chamber Detection Test Workflow" and .status == "completed" and .conclusion == "success") 
             | .id' | head -n 1)

        if [ -n "$run_id" ]; then
          echo "âœ… Found previous run: $run_id"
          gh run download "$run_id" -n changed-files
          if [ -f changed_files.txt ]; then
            echo "âœ… Reused changed_files.txt"
            echo "exists=true" >> "$GITHUB_OUTPUT"
            cat changed_files.txt
          else
            echo "âŒ changed_files.txt not found in artifact"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        else
          echo "âŒ No previous successful run for this commit"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Detect changed files if no artifact found
      if: steps.download.outputs.exists != 'true'
      run: |
        git diff --name-only HEAD~1 > changed_files.txt
        echo "ğŸ“ Detected changes:"
        cat changed_files.txt

    - name: Upload changed-files artifact (only on first push)
      if: steps.download.outputs.exists != 'true' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: changed-files
        path: changed_files.txt

    - name: Set AWS and CC flags
      id: setflags
      run: |
        AWS=false
        CC=false
        while IFS= read -r line; do
          if [[ "$line" == dn01/* ]]; then AWS=true; fi
          if [[ "$line" == dn02/* ]]; then CC=true; fi
        done < changed_files.txt

        echo "AWS: $AWS | CC: $CC"
        echo "aws_changed=$AWS" >> "$GITHUB_OUTPUT"
        echo "cc_changed=$CC" >> "$GITHUB_OUTPUT"

  aws_chamber_deployment:
    runs-on: ubuntu-latest
    needs: pre_chamber_deployment
    if: needs.pre_chamber_deployment.outputs.aws_changed == 'true'

    steps:
    - name: AWS Chamber Logic
      run: echo "âœ… AWS chamber triggered due to changes in dn01/*"

  cc_chamber_deployment:
    runs-on: ubuntu-latest
    needs: pre_chamber_deployment
    if: needs.pre_chamber_deployment.outputs.cc_changed == 'true'

    steps:
    - name: CC Chamber Logic
      run: echo "âœ… CC chamber triggered due to changes in dn02/*"
